import{u as ie,f as d,g as de,l as I,o as n,c as r,a as t,b as ce,t as u,n as me,d as v,F as C,r as R,e as ve,w as $,v as O,m as fe,p as ge,R as k,h as H}from"./index-829fb2a4.js";import{w as pe}from"./workingTimes-4122bb68.js";import{c as Y,C as j}from"./auto-3ead7ee4.js";import{_ as ye}from"./_plugin-vue_export-helper-c27b6911.js";const be={class:"p-6 max-w-7xl mx-auto bg-white"},he={class:"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6 p-4 bg-gray-50 rounded-lg"},_e={key:0,class:"text-gray-600 mt-1"},xe={class:"text-gray-800"},ke={class:"flex flex-wrap gap-3"},we={class:"px-3 py-1.5 bg-white border border-gray-200 rounded-lg shadow-sm text-sm"},Ce={class:"ml-1 font-medium text-gray-900"},Me={class:"px-3 py-1.5 bg-white border border-yellow-100 rounded-lg shadow-sm text-sm"},Ae={class:"ml-1 font-medium text-yellow-900"},Se={class:"px-3 py-1.5 bg-white border border-blue-100 rounded-lg shadow-sm text-sm"},De={class:"ml-1 font-medium text-blue-900"},$e={class:"bg-white rounded-lg shadow p-6 mb-6"},Te={key:0,class:"text-gray-600"},Be={key:1,class:"text-red-600"},Ee={key:2,class:"text-gray-500"},Ue={key:3,class:"min-w-full divide-y divide-gray-200"},Ne={class:"card"},Fe={key:0,class:"hint"},Ve={class:"table"},Le={class:"chart-box"},We={class:"card"},Pe={class:"chart-box"},Ie={class:"card"},Re={key:0,class:"hint"},Oe={key:1,class:"chart-box"},Ye={class:"modal"},je={class:"form"},Ze={class:"form-group"},ze={class:"form-group"},Je={class:"form-group"},Ge={key:0,class:"form-group"},He=["disabled"],qe=["value"],Ke={key:1,class:"error-message"},Qe={class:"actions"},Xe={class:"action-buttons"},et=["disabled"],tt=["disabled"],st={class:"danger-zone"},at=["disabled"],lt={__name:"DashboardView",setup(ot){const q=ie(),a=d(null),f=d(!1),g=d("");d("");const M=d([]),b=d([]),A=d([]),T=d(0),B=d(0),E=d(null),U=d(null),N=d(null);let F=null,V=null,L=null;const w=d(!1);d(!1);const i=d({username:"",first_name:"",last_name:""}),K=async()=>{var l;if((l=a.value)!=null&&l.id){loading.value=!0,g.value="";try{const e=await pe.list(a.value.id),s=Array.isArray(e)?e:Array.isArray(e==null?void 0:e.data)?e.data:[],m=new Date,_=m.getFullYear(),p=m.getMonth(),o=m.getDate(),y=c=>{if(!c)return!1;const x=new Date(c);return x.getFullYear()===_&&x.getMonth()===p&&x.getDate()===o},ne=s.filter(c=>y(c.start||c.start_time||c.startTime));M.value=ne.map(c=>{const x=c.start||c.start_time||c.startTime,Z=c.end||c.end_time||c.endTime,W=x?Date.parse(x):null,P=Z?Date.parse(Z):null,z=W&&P?Math.max(0,Math.floor((P-W)/1e3)):0,re=Math.floor(z/60),ue=z%60,J=G=>G?new Date(G).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"--:--";return{start:J(W),end:J(P),duration:`${re}m ${String(ue).padStart(2,"0")}s`}})}catch{g.value="Failed to load today's sessions"}finally{loading.value=!1}}},S=l=>{const e=Math.max(0,Math.floor(Number(l)||0)),s=Math.floor(e/60),m=e%60;return`${s}:${String(m).padStart(2,"0")}`},Q=async()=>{var _;if(!((_=a.value)!=null&&_.id))return;const l=await Y.hoursByUser(a.value.id);b.value=Array.isArray(l==null?void 0:l.data)?l.data:[];const e=await Y.sessionsByUser(a.value.id);A.value=Array.isArray(e==null?void 0:e.data)?e.data:[];const s=await Y.breaksByUser(a.value.id),m=Array.isArray(s==null?void 0:s.data)?s.data:[];T.value=b.value.reduce((p,o)=>p+(o.minutes||0),0),B.value=m.reduce((p,o)=>p+(o.minutes||0),0),X(m)},X=l=>{const e=b.value.map(o=>o.date),s=b.value.map(o=>o.minutes);F&&F.destroy(),E.value&&(F=new j(E.value.getContext("2d"),{type:"bar",data:{labels:e,datasets:[{label:"Minutes Worked",data:s,borderColor:"#60a5fa",backgroundColor:"rgba(96,165,250,0.5)"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{tooltip:{callbacks:{label:o=>` ${o.parsed.y}m (${S(o.parsed.y*60)})`}},legend:{position:"bottom"}},scales:{y:{beginAtZero:!0,ticks:{callback:o=>`${o}m`}}}}}));const m=s.reduce((o,y)=>o+y,0),_=l.reduce((o,y)=>o+(y.minutes||0),0);V&&V.destroy(),U.value&&(V=new j(U.value.getContext("2d"),{type:"doughnut",data:{labels:["Work","Break"],datasets:[{data:[m,_],backgroundColor:["#34d399","#f87171"],borderWidth:0}]},options:{cutout:"60%",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom"},tooltip:{callbacks:{label:o=>` ${o.formattedValue}m (${S(o.parsed*60)})`}}}}}));const p=A.value.map((o,y)=>({x:y+1,y:o.minutes}));L&&L.destroy(),N.value&&(L=new j(N.value.getContext("2d"),{type:"scatter",data:{datasets:[{label:"Session Minutes",data:p,backgroundColor:"#93c5fd"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{tooltip:{callbacks:{label:o=>` ${o.raw.y}m (${S(o.raw.y*60)})`}},legend:{display:!1}},scales:{x:{title:{display:!0,text:"Session #"}},y:{beginAtZero:!0,title:{display:!0,text:"Minutes"}}}}}))};de(()=>{try{a.value=JSON.parse(localStorage.getItem("currentUser")||"null")}catch{a.value=null}a.value&&(i.value={username:a.value.username||"",first_name:a.value.first_name||"",last_name:a.value.last_name||""}),K(),Q()});const ee=()=>{a.value&&(i.value={username:a.value.username||"",first_name:a.value.first_name||"",last_name:a.value.last_name||"",role:a.value.role||k.EMPLOYEE},w.value=!0,g.value="",f.value=!1)},h=I(()=>a.value?a.value.role||k.EMPLOYEE:""),D=I(()=>h.value===k.ADMIN),te=I(()=>[k.ADMIN,k.MANAGER].includes(h.value)),se=()=>{localStorage.removeItem("currentUser"),q.push("/login")},ae=async()=>{if(a.value){f.value=!0;try{const l={username:i.value.username,first_name:i.value.first_name,last_name:i.value.last_name};D.value&&i.value.role&&(l.role=i.value.role);const e=await H.update(a.value.id,l),s=(e==null?void 0:e.data)||e;a.value=s,localStorage.setItem("currentUser",JSON.stringify(a.value)),w.value=!1}catch(l){console.error("Failed to update profile",l),alert("Failed to save profile. "+(l.message||"Ensure backend is running and migration applied."))}finally{f.value=!1}}},le=()=>{confirm("⚠️ Are you sure you want to delete your account? This action cannot be undone!")&&oe()},oe=async()=>{if(a.value&&confirm("This will permanently delete your account and all associated data. Are you absolutely sure?")){f.value=!0;try{await H.remove(a.value.id),alert("Your account has been deleted successfully."),se()}catch(l){console.error("Failed to delete account",l),alert("Failed to delete account: "+(l.message||"Please try again later."))}finally{f.value=!1}}};return(l,e)=>(n(),r(C,null,[t("section",be,[t("div",he,[t("div",null,[e[9]||(e[9]=t("h1",{class:"text-2xl font-bold text-gray-900"},"Dashboard",-1)),a.value?(n(),r("p",_e,[e[8]||(e[8]=ce(" Welcome, ",-1)),t("b",xe,u(a.value.username||[a.value.first_name,a.value.last_name].filter(Boolean).join(" ")),1),t("span",{class:me(["ml-2 px-2 py-0.5 text-xs font-medium rounded-full",{"bg-purple-100 text-purple-800":h.value==="admin","bg-blue-100 text-blue-800":h.value==="manager","bg-green-100 text-green-800":h.value==="employee"}])},u(h.value),3)])):v("",!0)]),t("div",ke,[t("span",we,[e[10]||(e[10]=t("span",{class:"text-gray-500"},"Work",-1)),t("span",Ce,u(T.value)+"m ("+u(T.value*60)+"s)",1)]),t("span",Me,[e[11]||(e[11]=t("span",{class:"text-yellow-700"},"Break",-1)),t("span",Ae,u(B.value)+"m ("+u(B.value*60)+"s)",1)]),t("span",Se,[e[12]||(e[12]=t("span",{class:"text-blue-700"},"Sessions",-1)),t("span",De,u(A.value.length),1)]),D.value?(n(),r("button",{key:0,onClick:e[0]||(e[0]=s=>l.$router.push("/admin/users")),class:"flex items-center gap-1.5 px-3 py-1.5 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"},[...e[13]||(e[13]=[t("span",null,"👥",-1),t("span",null,"Manage Users",-1)])])):v("",!0),te.value?(n(),r("button",{key:1,onClick:e[1]||(e[1]=s=>l.$router.push("/team")),class:"flex items-center gap-1.5 px-3 py-1.5 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"},[...e[14]||(e[14]=[t("span",null,"👥",-1),t("span",null,"My Team",-1)])])):v("",!0),t("button",{onClick:ee,class:"px-3 py-1.5 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"}," Edit Profile ")])]),t("div",$e,[e[16]||(e[16]=t("h2",{class:"text-lg font-semibold text-gray-900 mb-4"},"Today's Sessions",-1)),l.loading?(n(),r("p",Te,"Loading…")):v("",!0),g.value?(n(),r("p",Be,u(g.value),1)):v("",!0),!l.loading&&M.value.length===0?(n(),r("div",Ee,"No sessions recorded today.")):v("",!0),!l.loading&&M.value.length?(n(),r("table",Ue,[e[15]||(e[15]=t("thead",null,[t("tr",null,[t("th",null,"Start"),t("th",null,"End"),t("th",null,"Duration")])],-1)),t("tbody",null,[(n(!0),r(C,null,R(M.value,(s,m)=>(n(),r("tr",{key:m},[t("td",null,u(s.start),1),t("td",null,u(s.end),1),t("td",null,u(s.duration),1)]))),128))])])):v("",!0)]),t("div",Ne,[e[18]||(e[18]=t("h2",null,"Working Time (Line)",-1)),b.value.length===0?(n(),r("div",Fe,"No working time yet.")):(n(),r(C,{key:1},[t("table",Ve,[e[17]||(e[17]=t("thead",null,[t("tr",null,[t("th",null,"Date"),t("th",null,"Minutes"),t("th",null,"mm:ss"),t("th",null,"Hours")])],-1)),t("tbody",null,[(n(!0),r(C,null,R(b.value,s=>(n(),r("tr",{key:s.date},[t("td",null,u(s.date),1),t("td",null,u((s.seconds/60).toFixed(2)),1),t("td",null,u(S(s.seconds)),1),t("td",null,u(s.hours),1)]))),128))])]),t("div",Le,[t("canvas",{ref_key:"hoursCanvas",ref:E,height:"120"},null,512)])],64))]),t("div",We,[e[19]||(e[19]=t("h2",null,"Breaks vs Work (Doughnut)",-1)),t("div",Pe,[t("canvas",{ref_key:"pieCanvas",ref:U,height:"120"},null,512)]),e[20]||(e[20]=t("div",{class:"hint"},"Breaks and total session minutes from your history.",-1))]),t("div",Ie,[e[21]||(e[21]=t("h2",null,"Working Sessions (Scatter)",-1)),A.value.length===0?(n(),r("div",Re,"No sessions yet.")):(n(),r("div",Oe,[t("canvas",{ref_key:"scatterCanvas",ref:N,height:"120"},null,512)]))])]),w.value?(n(),r("div",{key:0,class:"modal-backdrop",onClick:e[7]||(e[7]=ve(s=>w.value=!1,["self"]))},[t("div",Ye,[e[27]||(e[27]=t("h3",null,"Edit Profile",-1)),t("div",je,[t("div",Ze,[e[22]||(e[22]=t("label",null,"Username",-1)),$(t("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>i.value.username=s),type:"text",class:"form-control"},null,512),[[O,i.value.username,void 0,{trim:!0}]])]),t("div",ze,[e[23]||(e[23]=t("label",null,"First name",-1)),$(t("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>i.value.first_name=s),type:"text",class:"form-control"},null,512),[[O,i.value.first_name,void 0,{trim:!0}]])]),t("div",Je,[e[24]||(e[24]=t("label",null,"Last name",-1)),$(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>i.value.last_name=s),type:"text",class:"form-control"},null,512),[[O,i.value.last_name,void 0,{trim:!0}]])]),D.value?(n(),r("div",Ge,[e[25]||(e[25]=t("label",null,"Role",-1)),$(t("select",{"onUpdate:modelValue":e[5]||(e[5]=s=>i.value.role=s),class:"form-control",disabled:!D.value},[(n(!0),r(C,null,R(Object.values(ge(k)),s=>(n(),r("option",{key:s,value:s},u(s.charAt(0).toUpperCase()+s.slice(1)),9,qe))),128))],8,He),[[fe,i.value.role]])])):v("",!0),g.value?(n(),r("div",Ke,u(g.value),1)):v("",!0)]),t("div",Qe,[t("div",Xe,[t("button",{class:"ghost",onClick:e[6]||(e[6]=s=>w.value=!1),disabled:f.value}," Cancel ",8,et),t("button",{onClick:ae,disabled:f.value},u(f.value?"Saving...":"Save Changes"),9,tt)]),t("div",st,[e[26]||(e[26]=t("h4",null,"Danger Zone",-1)),t("button",{class:"danger",onClick:le,disabled:f.value,title:"Permanently delete your account"}," 🗑️ Delete My Account ",8,at)])])])])):v("",!0)],64))}},dt=ye(lt,[["__scopeId","data-v-c6f8df20"]]);export{dt as default};
