import{r,f as B,g as re,h as le,o as S,c as _,a as e,n as ne,t as a,b as M,w as F,v as z,e as de,m as y,A as ie}from"./index-5e39243b.js";import{userSchedulesApi as ue}from"./userSchedules-3305ba19.js";import{workingTimesApi as ce}from"./workingTimes-66cf2fe5.js";import{e as J}from"./emailService-406cfe07.js";import"./http-8cebfae0.js";const ge=c=>{if(!c)return"00:00:00";const l=c instanceof Date?c:new Date(c);if(isNaN(l.getTime()))return"00:00:00";const n=l.getHours().toString().padStart(2,"0"),v=l.getMinutes().toString().padStart(2,"0"),p=l.getSeconds().toString().padStart(2,"0");return`${n}:${v}:${p}`},me=c=>{if(!c||c===0)return"00:00:00";const l=Math.floor(c),n=(c-l)*60,v=Math.floor(n),p=Math.round((n-v)*60);return`${l.toString().padStart(2,"0")}:${v.toString().padStart(2,"0")}:${p.toString().padStart(2,"0")}`},ve={class:"min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8"},fe={class:"max-w-4xl mx-auto"},xe={class:"bg-white rounded-xl shadow-lg border border-gray-200 p-8 mb-6"},be={class:"text-center mb-8"},ye={class:"text-4xl"},pe={class:"text-2xl font-bold text-gray-900 mb-2"},he={class:"text-gray-600"},we={key:0,class:"bg-blue-50 rounded-lg p-6 mb-6 text-center"},Se={class:"text-4xl font-bold text-blue-900 font-mono"},_e={class:"text-sm text-blue-600 mt-2"},ke={class:"bg-gray-50 rounded-lg p-4 mb-6"},Ee={key:0,class:"mb-3 p-2 bg-blue-100 border border-blue-300 rounded-lg"},Te={class:"grid grid-cols-2 gap-4 text-center"},Me={class:"text-lg font-bold text-gray-900"},De={class:"text-lg font-bold text-gray-900"},Ae={class:"flex gap-4"},We=["disabled"],Ce=["disabled"],He={class:"bg-white rounded-xl shadow-sm border border-gray-200 p-6"},Oe={class:"grid grid-cols-3 gap-4"},Ie={class:"text-center p-4 bg-blue-50 rounded-lg"},Ne={class:"text-2xl font-bold text-blue-600"},$e={class:"text-center p-4 bg-green-50 rounded-lg"},Ue={class:"text-2xl font-bold text-green-600"},Le={class:"text-center p-4 bg-orange-50 rounded-lg"},je={class:"text-2xl font-bold text-orange-600"},Ve={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},Ye={class:"bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6"},Pe={class:"text-center mb-4"},Re={class:"text-gray-600 mt-2"},Be={class:"mb-4"},Fe={class:"flex gap-3"},ze=["disabled"],Je={key:1,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},qe={class:"bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-6"},Ge={class:"text-center mb-4"},Ke={class:"text-orange-700 mt-2"},Qe={class:"mb-4"},Xe={class:"flex gap-3"},Ze=["disabled"],rt={__name:"WorkSessionView",setup(c){const l=r(!1),n=r(!1),v=r(null),p=r(null),D=r(0),$=r("0:00"),U=r("0:00"),L=r("0:00"),f=r("09:00"),h=r("17:00"),W=r(!1),C=r(!1),w=r(""),k=r(""),H=r(""),O=r(0),I=r(0);let E=null;const x=r(null),q=B(()=>n.value?`You started work at ${v.value}`:'Click "Work Start" to begin your day'),G=B(()=>{const s=Math.floor(D.value/3600),t=Math.floor(D.value%3600/60),o=D.value%60;return`${s.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}),K=async()=>{try{const s=JSON.parse(localStorage.getItem("currentUser")||"{}");x.value=s;const o=(await ue.getByUser(s.id)).data||[];console.log("Loaded schedules:",o);const g=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][new Date().getDay()],i=o.find(u=>u.day_of_week.toLowerCase()===g);if(console.log("Today is:",g),console.log("Today schedule:",i),i){const u=i.scheduled_start_time||i.start_time,b=i.scheduled_end_time||i.end_time;f.value=Y(u),h.value=Y(b),console.log("Set scheduled start to:",f.value),console.log("Set scheduled end to:",h.value)}else console.log("No schedule found for today, using defaults: 09:00 - 17:00")}catch(s){console.error("Error loading user schedule:",s),console.log("Using default schedule: 09:00 - 17:00"),f.value="09:00",h.value="17:00"}},Q=async()=>{console.log("ðŸŸ¡ Work Session status check - independent of clock system"),n.value=!1,await V()},X=async()=>{var A,R;const s=new Date,t=`${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}`;if(H.value=t,console.log("Current time:",t),console.log("Scheduled start:",f.value),console.log("Scheduled end:",h.value),console.log("Flexible time enabled:",(A=x.value)==null?void 0:A.flexible_time_enabled),(R=x.value)!=null&&R.flexible_time_enabled){console.log("User has flexible time permission - starting work without alerts"),await N();return}const[o,d]=f.value.split(":").map(Number),[g,i]=h.value.split(":").map(Number),u=o*60+d,b=g*60+i,m=s.getHours()*60+s.getMinutes();console.log("Current time (minutes):",m),console.log("Scheduled start (minutes):",u),console.log("Scheduled end (minutes):",b),m<u?(O.value=u-m,console.log("Early by",O.value,"minutes"),W.value=!0):m>b?(I.value=m-b,console.log("Late by",I.value,"minutes"),C.value=!0):(console.log("Within scheduled hours, starting work normally"),await N())},Z=async()=>{W.value=!1,x.value&&await J.sendEarlyArrivalNotification(x.value,{scheduled_start:f.value,actual_start:H.value,early_minutes:O.value,reason:w.value}),await N(w.value),w.value=""},ee=()=>{W.value=!1,w.value=""},te=async()=>{C.value=!1,x.value&&y.warning(`Starting work ${I.value} minutes after scheduled end time`),await N(k.value,!0),k.value=""},se=()=>{C.value=!1,k.value=""},N=async(s=null,t=!1)=>{var o;l.value=!0;try{const d=JSON.parse(localStorage.getItem("currentUser")||"{}");try{const g=(await ie(()=>import("./attendance-2186c79e.js"),["assets/attendance-2186c79e.js","assets/http-8cebfae0.js"])).attendanceApi,i=new Date().toISOString().split("T")[0];((o=(await g.list()).data)==null?void 0:o.find(m=>m.user_id===d.id&&m.date===i))?console.log("âœ… Attendance already marked for today"):(await g.create({user_id:d.id,date:i,status:"present"}),console.log("âœ… Attendance marked as present"))}catch(g){console.error("âš ï¸ Error marking attendance:",g)}n.value=!0,p.value=new Date,v.value=P(new Date),ae(),y.success("Work started successfully!"),s&&!t?y.info(`Early start reason recorded: ${s}`):s&&t&&y.warning(`Late start reason recorded: ${s}`)}catch(d){console.error("Error starting work:",d),y.error("Failed to start work")}finally{l.value=!1}},oe=async()=>{console.log("ðŸŸ¡ Work End button pressed - COMPLETELY SEPARATE from Clock Out"),l.value=!0;try{const s=new Date,t=(s-p.value)/1e3/60/60,o=Math.max(0,t-8);o>0&&x.value&&await J.sendOvertimeAlert(x.value,{total_hours:T(t),overtime_hours:T(o),work_start:v.value,work_end:P(s)}),n.value=!1,j(),clearEndOfDayAlert(),await V(),y.success("Work ended successfully!"),o>0&&y.info(`Overtime recorded: ${T(o)}`)}catch(s){console.error("Error ending work:",s),y.error("Failed to end work")}finally{l.value=!1}},ae=()=>{E&&clearInterval(E),E=setInterval(()=>{const s=new Date;D.value=Math.floor((s-p.value)/1e3)},1e3)},j=()=>{E&&(clearInterval(E),E=null),D.value=0},V=async()=>{try{const s=JSON.parse(localStorage.getItem("currentUser")||"{}"),t=new Date,o=new Date(t.setHours(0,0,0,0)),d=new Date(t.setHours(23,59,59,999)),i=(await ce.list(s.id,o.toISOString(),d.toISOString())).data||[];let u=0;i.forEach(A=>{A.actual_hours&&(u+=A.actual_hours)});const b=Math.min(u,8),m=Math.max(0,u-8);$.value=T(u),U.value=T(b),L.value=T(m)}catch(s){console.error("Error loading today summary:",s)}},Y=s=>s?s.length>=8?s.substring(0,8):s.substring(0,5)+":00":"00:00:00",P=s=>ge(s),T=s=>me(s);return re(async()=>{await K(),await Q(),console.log("ðŸŸ¡ Work Session mounted - no automatic end-of-day checking")}),le(()=>{j()}),(s,t)=>{var o;return S(),_("div",ve,[e("div",fe,[t[13]||(t[13]=e("div",{class:"mb-8"},[e("h1",{class:"text-3xl font-bold text-gray-900 mb-2"},"Work Session"),e("p",{class:"text-gray-600"},"Start and end your work day with smart time tracking")],-1)),e("div",xe,[e("div",be,[e("div",{class:ne(["inline-flex items-center justify-center w-24 h-24 rounded-full mb-4",n.value?"bg-green-100":"bg-gray-100"])},[e("span",ye,a(n.value?"ðŸ¢":"ðŸ "),1)],2),e("h2",pe,a(n.value?"Currently Working":"Not Working"),1),e("p",he,a(q.value),1)]),n.value?(S(),_("div",we,[t[2]||(t[2]=e("p",{class:"text-sm text-blue-600 font-medium mb-2"},"Work Duration",-1)),e("p",Se,a(G.value),1),e("p",_e,"Started at "+a(v.value),1)])):M("",!0),e("div",ke,[(o=x.value)!=null&&o.flexible_time_enabled?(S(),_("div",Ee,[...t[3]||(t[3]=[e("div",{class:"flex items-center justify-center gap-2"},[e("span",{class:"text-lg"},"âš¡"),e("span",{class:"text-sm font-medium text-blue-900"},"Flexible Time Enabled")],-1),e("p",{class:"text-xs text-blue-700 text-center mt-1"},"You can work anytime without early/late alerts",-1)])])):M("",!0),e("div",Te,[e("div",null,[t[4]||(t[4]=e("p",{class:"text-sm text-gray-500"},"Scheduled Start",-1)),e("p",Me,a(f.value),1)]),e("div",null,[t[5]||(t[5]=e("p",{class:"text-sm text-gray-500"},"Scheduled End",-1)),e("p",De,a(h.value),1)])])]),t[8]||(t[8]=e("div",{class:"bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4"},[e("p",{class:"text-sm text-yellow-800 font-medium mb-2"},"âš ï¸ Independent Work Tracking"),e("p",{class:"text-xs text-yellow-700"},"This is separate from Clock In/Out. Use Clock In/Out for actual attendance tracking.")],-1)),e("div",Ae,[n.value?M("",!0):(S(),_("button",{key:0,onClick:X,class:"flex-1 py-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2",disabled:l.value},[t[6]||(t[6]=e("span",{class:"text-2xl"},"â–¶ï¸",-1)),e("span",null,a(l.value?"Starting...":"Work Start (Independent)"),1)],8,We)),n.value?(S(),_("button",{key:1,onClick:oe,class:"flex-1 py-4 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center gap-2",disabled:l.value},[t[7]||(t[7]=e("span",{class:"text-2xl"},"â¹ï¸",-1)),e("span",null,a(l.value?"Ending...":"Work End (Independent)"),1)],8,Ce)):M("",!0)])]),e("div",He,[t[12]||(t[12]=e("h3",{class:"text-lg font-semibold text-gray-900 mb-4"},"Today's Summary",-1)),e("div",Oe,[e("div",Ie,[e("p",Ne,a($.value),1),t[9]||(t[9]=e("p",{class:"text-sm text-blue-600"},"Total Hours",-1))]),e("div",$e,[e("p",Ue,a(U.value),1),t[10]||(t[10]=e("p",{class:"text-sm text-green-600"},"Regular Hours",-1))]),e("div",Le,[e("p",je,a(L.value),1),t[11]||(t[11]=e("p",{class:"text-sm text-orange-600"},"Overtime",-1))])])])]),W.value?(S(),_("div",Ve,[e("div",Ye,[e("div",Pe,[t[14]||(t[14]=e("span",{class:"text-6xl"},"ðŸŒ…",-1)),t[15]||(t[15]=e("h3",{class:"text-xl font-bold text-gray-900 mt-4"},"You're Early!",-1)),e("p",Re," Your scheduled start time is "+a(f.value)+", but you're starting at "+a(H.value)+". That's "+a(O.value)+" minutes early. ",1)]),e("div",Be,[t[16]||(t[16]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," Please provide a reason for early arrival: ",-1)),F(e("textarea",{"onUpdate:modelValue":t[0]||(t[0]=d=>w.value=d),rows:"3",class:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., Early meeting, catching up on work, etc."},null,512),[[z,w.value]])]),e("div",Fe,[e("button",{onClick:Z,class:"flex-1 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700",disabled:!w.value.trim()}," Start Work ",8,ze),e("button",{onClick:ee,class:"flex-1 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300"}," Cancel ")])])])):M("",!0),C.value?(S(),_("div",Je,[e("div",qe,[e("div",Ge,[t[17]||(t[17]=e("span",{class:"text-6xl"},"âš ï¸",-1)),t[18]||(t[18]=e("h3",{class:"text-xl font-bold text-orange-900 mt-4"},"Starting After Scheduled Hours!",-1)),e("p",Ke," Your scheduled work hours are "+a(f.value)+" - "+a(h.value)+". You're starting at "+a(H.value)+", which is "+a(I.value)+" minutes after your scheduled end time. ",1)]),e("div",Qe,[t[19]||(t[19]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," Please provide a reason for starting after scheduled hours: ",-1)),F(e("textarea",{"onUpdate:modelValue":t[1]||(t[1]=d=>k.value=d),rows:"3",class:"w-full px-3 py-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500",placeholder:"e.g., Special project, overtime work, urgent task, etc."},null,512),[[z,k.value]])]),t[20]||(t[20]=e("div",{class:"bg-orange-50 border border-orange-200 rounded-lg p-3 mb-4"},[e("p",{class:"text-sm text-orange-800"},[e("strong",null,"Note:"),de(" Starting work after your scheduled end time may result in overtime hours being tracked. ")])],-1)),e("div",Xe,[e("button",{onClick:te,class:"flex-1 py-2 bg-orange-600 text-white font-medium rounded-lg hover:bg-orange-700",disabled:!k.value.trim()}," Start Work ",8,Ze),e("button",{onClick:se,class:"flex-1 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300"}," Cancel ")])])])):M("",!0)])}}};export{rt as default};
